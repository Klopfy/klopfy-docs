<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Documentation Virsh/KVM :: Personal Documentation Site</title>
    <link rel="prev" href="haproxy.html">
    <link rel="next" href="networking.html">
    <meta name="generator" content="Antora 3.1.2">
    <script>
!function (theme) {
  if (theme === 'dark') document.documentElement.classList.add('dark-theme')
}(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)') && 'dark'))
    </script>
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://antora.org">Antora</a>
        <span class="separator">//</span>
        <a href="../..">Personal Notes</a>
      </div>
      <div class="navbar-item search hide-for-print">
        <input id="search-input" type="text" placeholder="Search the docs">
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">


        <div id="switch-theme">
          <input type="checkbox" id="switch-theme-checkbox" />
          <label for="switch-theme-checkbox">Dark Theme</label>
        </div>
<!--
        <button type="button" id="themeSwitch">
        </button>
-->

<!--
        <button type="button" id="themeSwitch" class="hidden sm:block stroke-white fill-white ">
          <span class="dark:hidden">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
              <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
              <path d="M12 4v1M17.66 6.344l-.828.828M20.005 12.004h-1M17.66 17.664l-.828-.828M12 20.01V19M6.34 17.664l.835-.836M3.995 12.004h1.01M6 6l.835.836"></path>
            </svg>
          </span>
          <span class="hidden dark:inline">
            <svg viewBox="0 0 512 512" class="w-4 h-4">
              <path d="M421.6 379.9c-.6641 0-1.35 .0625-2.049 .1953c-11.24 2.143-22.37 3.17-33.32 3.17c-94.81 0-174.1-77.14-174.1-175.5c0-63.19 33.79-121.3 88.73-152.6c8.467-4.812 6.339-17.66-3.279-19.44c-11.2-2.078-29.53-3.746-40.9-3.746C132.3 31.1 32 132.2 32 256c0 123.6 100.1 224 223.8 224c69.04 0 132.1-31.45 173.8-82.93C435.3 389.1 429.1 379.9 421.6 379.9zM255.8 432C158.9 432 80 353 80 256c0-76.32 48.77-141.4 116.7-165.8C175.2 125 163.2 165.6 163.2 207.8c0 99.44 65.13 183.9 154.9 212.8C298.5 428.1 277.4 432 255.8 432z"/>
            </svg>
          </span>
        </button>
-->
<!--
        <div id="switch-theme">
          <input type="checkbox" id="switch-theme-checkbox" />
          <label for="switch-theme-checkbox">Dark Theme</label>
        </div>
-->


        <a class="navbar-item" href="https://github.com/Klopfy">
          <span class="icon">
            <svg aria-hidden="true" class="octicon octicon-mark-github" height="24" version="1.1" viewBox="0 0 16 16" width="24">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="homelab" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="ansible.html">Homelab</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ansible.html">Ansible</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="firewalld.html">Firewalld</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="foreman.html">Foreman</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="freeipa.html">FreeIPA</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="haproxy.html">HAProxy</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="kvm_virsh.html">Documentation Virsh/KVM</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="networking.html">Networking</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="nginx.html">Nginx</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rpm.html">RPM Package Manager</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Monitoring</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring/blackbox_exporter.html">Blackbox exporter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring/grafana.html">Grafana</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring/haproxy.html">HAProxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring/node_exporter.html">Node exporter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring/prometheus.html">Prometheus</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Homelab</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../antora/3.1/index.html">Antora</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../antora/3.1/index.html">3.1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="ansible.html">Homelab</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="ansible.html">main</a>
        </li>
        <li class="version">
          <a href="../alpha/ansible.html">alpha</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="ansible.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="ansible.html">Homelab</a></li>
    <li><a href="kvm_virsh.html">Documentation Virsh/KVM</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">main</button>
  <div class="version-menu">
    <a class="version is-current" href="kvm_virsh.html">main</a>
    <a class="version" href="../alpha/kvm_virsh.html">alpha</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/Klopfy/antora/edit/main/modules/ROOT/pages/kvm_virsh.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Documentation Virsh/KVM</h1>
<div class="ulist">
<ul>
<li>
<p>List active domain</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh list</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List all domains</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">virsh list --all</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List all network</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">virsh net-list</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Start an existing domain</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh start &lt;domain name&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Attach a console to a domain</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh console &lt;domain name&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Attach a window view to a domain</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">remote-viewer spice://localhost:5900</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove a domain/VM</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh undefine &lt;domain name&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatically start a host a startup</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh autostart &lt;vm_name&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete/Create snapshot</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh snapshot-delete --domain foreman --snapshotname "foreman_before_kat_install"
virsh snapshot-create-as --domain foreman --name "foreman_before_kat_install"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new VM with virt-install</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-install -n test --description "Command Line Test - Centos" --os-type=Linux --os-variant=centos8 --ram=2048 --vcpus=2 --disk path=/var/lib/libvirt/images/test.img,bus=virtio,size=10 --location /var/CentOS-Stream-8-x86_64-20210608-dvd1.iso --network bridge=virbr0 --boot menu=on --console pty --extra-args 'console=ttyS0' --boot useserial=on --graphics none</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new VM with virt-install and kickstart</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-install --name test --memory 2048 --vcpus 2 --disk path=/var/lib/libvirt/images/test.qcow2,bus=virtio,size=10 --location /var/CentOS-Stream-8-x86_64-20210608-dvd1.iso --os-variant centos-stream8 --network bridge=virbr0 --initrd-inject /home/luc/Documents/lab/new/ks.cfg --extra-args='inst.ks=file:/ks.cfg'</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Kickstarter file example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">#version=RHEL8
# Use text mode install
text


## Test from https://forums.centos.org/viewtopic.php?t=73184
url --url http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/
repo --name=AppStream --baseurl=http://mirror.centos.org/centos/8-stream/AppStream/x86_64/os/
#repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0001-cdrom/AppStream

%packages
@^minimal-environment
kexec-tools

%end

# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=enp1s0 --ipv6=auto --activate
network  --hostname=test

# Use CDROM installation media
cdrom

# Run the Setup Agent on first boot
firstboot --enable
# Do not configure the X Window System
skipx

ignoredisk --only-use=vda
# System bootloader configuration
bootloader --append="crashkernel=auto" --location=mbr --boot-drive=vda
autopart
# Partition clearing information
clearpart --linux --initlabel --drives=vda

# System timezone
timezone US/Eastern --isUtc

# Root password
rootpw --iscrypted $6$gdx2kXQ.qyUCBWfW$KnjbQhcbD9FRiG19FHpjIiEL/diKoQ//oBMYGJmAwqfQiVeOx6XEov8NivkUsglkNhYz9UMPywYoNhCpvE3aL.
user --groups=wheel --name=lklopfenstein --password=$6$cK7wuJ/2fxTrlQ53$8q9DyNMsoQ5hOCJo.i0f7zJJQIvUmHzOAK5.E032pWBiSaV1s2nGeodfX5Q14tW8i1ITgkYdB7/fiNchOs58g/ --iscrypted --gecos="Luc Klopfenstein"

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Changing partitionning for LVM: <a href="https://www.golinuxcloud.com/configure-thin-provision-lvm-centos-rhel-7-8/" class="bare">https://www.golinuxcloud.com/configure-thin-provision-lvm-centos-rhel-7-8/</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Disk partitioning information
part pv.746 --fstype="lvmpv" --ondisk=vda --size=1 --grow
part /boot --fstype="ext4" --ondisk=vda --size=512
part swap --fstype="swap" --ondisk=vda --size=2048
volgroup rhel --pesize=4096 pv.746
logvol none  --fstype="None" --size=1 --grow --thinpool --metadatasize=4 --chunksize=65536 --name=pool00 --vgname=rhel
logvol /  --fstype="ext4" --size=10240 --thin --poolname=pool00 --name=root --vgname=rhel
logvol /home  --fstype="ext4" --size=1024 --thin --poolname=pool00 --name=home --vgname=rhel
logvol swap  --fstype="swap" --size=2048 --thin --poolname=pool00 --name=swap --vgname=rhel</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding SSHKey to user: <a href="https://docs.fedoraproject.org/en-US/Fedora/25/html/Installation_Guide/sect-kickstart-commands-sshkey.html" class="bare">https://docs.fedoraproject.org/en-US/Fedora/25/html/Installation_Guide/sect-kickstart-commands-sshkey.html</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">sshkey â€“username=lklopfenstein "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCpxYDZnj1TfN73zB6y6ANSOOxSDckACn+Lbj1Kf3g5FpRa49xDa15zvkWkMTgjlwfmsMM0PlBXDR/XAArBZljIWOE35MFvt9Y1JbzFgAEeF2ZaFGMeFij4OpRvHkPs5w32TH9pCyPFdWCf8jecnS0/7eUBiboBObOlyrjKj642Tw7qmTHDv0Ei6D9ori9hY5xeI8PPMFkKsY41B3oW1ODiLIUvPVNHw4yMEd8gL7EFN39/lteFQUdpfc0qnV6owUvcwHdFYfUrtUQ7aMhdUbulcBWwEYey7kl/SF1WqHa94pek0ZajiU1fep0ai1koPwjZAzFnerv/6BZcNjI7HipYlhXOwQqJmXQExeQMFC6WhjbILDRJ+lWwE7Xy6kUSD8/WmlI0N5zayv5sD1h57650CXCWssABrPAZarPy7ukNbcuFtzSJYHqj1m8/sIZnPyGpqBN3PJLZyrdMBh9r/A5hDwRR1nNv+77wKyAqT9+2yTy9Yda3b5gnGSoLgDTOkh8= link:mailto:&amp;#108;u&amp;#99;&amp;#x40;&amp;#x4b;&amp;#x6c;&amp;#x6f;&amp;#112;&amp;#x66;&amp;#x79;-&amp;#88;&amp;#x50;&amp;#83;-&amp;#49;&amp;#53;&amp;#45;7&amp;#53;9&amp;#x30;[&amp;#108;u&amp;#99;&amp;#x40;&amp;#x4b;&amp;#x6c;&amp;#x6f;&amp;#112;&amp;#x66;&amp;#x79;-&amp;#88;&amp;#x50;&amp;#83;-&amp;#49;&amp;#53;&amp;#45;7&amp;#53;9&amp;#x30;]"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Bashrc quick function to spawn VM</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">newvm() {

  if [ "$#" -ne 4 ]; then
    echo "Illegal number of parameters"
    echo "Usage: newvm &lt;vm_name[String]&gt; &lt;vcpus[Int]&gt; &lt;memory[Mo]&gt; &lt;disk[Go]&gt;"
  elif [ "$4" -le 15 ]; then
    echo "Unsufficient Disk storage given. Must be higher than 15Go."
  else
    vm_name="$1" #String
    vcpus="$2" #Number
    memory="$3" #In Mo
    size="$4" #In Go
    hostname="${vm_name}.internal-lab.net"
    disk_path="/var/lib/libvirt/images/${vm_name}.qcow2"
    #iso="/var/iso/CentOS-Stream-8-x86_64-20210608-dvd1.iso"
    iso="/var/iso/CentOS-Stream-8-x86_64-20211214-dvd1.iso"
    os_variant="centos-stream8"
    network="bridge=virbr0"
    kickstart="/home/luc/Documents/lab/new/ks.cfg"

    virt_install_cmd="virt-install --name $vm_name --memory $memory --vcpus $vcpus --disk path=$disk_path,bus=virtio,size=$size --location $iso --os-variant $os_variant --network $network --initrd-inject $kickstart --extra-args=\"inst.ks=file:/ks.cfg\""

    echo "$virt_install_cmd"

    read -p "Are you sure? [Yy]" -n 1 -r
    echo    # (optional) move to a new line
    if [[ ! $REPLY =~ ^[Yy]$ ]]
    then
      echo "Exiting"
    else
      echo "
      ==========================
         $(date +%F-%r)
      ==========================
      VM: $vm_name
      Hostname: $hostname
      Vcpus: $vcpus
      Memory: $memory
      Size: $size
      Disk Path: $disk_path
      OS Variant: $os_variant
      Network: $network
      Kickstart: $kickstart
      " &gt;&gt; /home/luc/Documents/lab/doc/lab/vm_details/"$vm_name".info


      echo "Pre-register host in IPA Server"
      ssh root@citools "kinit admin &amp;&amp; ipa host-add $hostname --password=secret --ip-address=1.1.1.1"
      return_code="$?"
      if [[ $return_code -eq 0  ]]; then

        sed -i "s#/usr/sbin/ipa-client-install --hostname=.*#/usr/sbin/ipa-client-install --hostname=$hostname --domain=internal-lab.net --enable-dns-updates --mkhomedir -w secret --realm=INTERNAL-LAB.NET --server=citools.internal-lab.net --unattended#g" /home/luc/Documents/lab/new/ks.cfg
        sed -i "s#network  --hostname.*#network  --hostname=$hostname#g" /home/luc/Documents/lab/new/ks.cfg
        eval "$virt_install_cmd"
        #virt-install --name "$vm_name" --memory "$memory" --vcpus "$vcpus" --disk path="$disk_path",bus=virtio,size="$size" --location "$iso" --os-variant "$os_variant" --network "$network" --initrd-inject "$kickstart" --extra-args="inst.ks=file:/ks.cfg"
      else
        echo "Error: IPA Server is either not running or pre-registration failed"
      fi
    fi
  fi
}</code></pre>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="haproxy.html">HAProxy</a></span>
  <span class="next"><a href="networking.html">Networking</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This website was built using <a href="https://antora.org/">Antora</a>. UI inspired of <a href="https://gitlab.com/antora/antora-ui-default">Antora Default UI</a> and <a href="https://github.com/spring-io/antora-ui-spring">Spring</a></p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
